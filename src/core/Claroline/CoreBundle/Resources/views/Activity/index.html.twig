{# to keep the workspace layout, extends this template #}
{% extends "ClarolineCoreBundle:Workspace:layout.html.twig" %}
{% block stylesheets %}
    {{ parent() }}
    <link rel='stylesheet' type='text/css' href='{{ asset('bundles/frontend/jquery/plugin/datepicker/css/datepicker.css')}}'>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts
        vars=["locale"]
        "@ClarolineCoreBundle/Resources/views/Resource/breadcrumbs.html.twigjs"
        "@ClarolineCoreBundle/Resources/views/Resource/actions.html.twigjs"
        "@ClarolineCoreBundle/Resources/views/Resource/filters.html.twigjs"
        "@ClarolineCoreBundle/Resources/views/Resource/thumbnail.html.twigjs"
        "@ClarolineCoreBundle/Resources/views/Resource/results.html.twigjs"
        "@ClarolineCoreBundle/Resources/views/modal.html.twigjs"
        filter="twig_js"
    %}
        <script language="javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type="text/javascript" src="{{ asset('bundles/frontend/underscore/underscore-1.3.3.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/frontend/backbone/backbone-0.9.2.min.js') }}"></script>
    <script type="text/javascript" src='{{ asset('../vendor/jms/twig-js/twig.js') }}'></script>
    <script type="text/javascript" src="{{ asset('bundles/frontend/jquery/plugin/datepicker/js/bootstrap-datepicker.js') }}" type="text/javascript"></script>
    <script type="text/javascript" src="{{ asset('bundles/clarolinecore/js/utilities.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/clarolinecore/js/resource/manager.js') }}"></script>
    <script type="text/javascript">
        $(function() {
            Claroline.ResourceManager.initialize({
                "parentElement": $('div.section-content'),
                "isPickerMultiSelectAllowed": false,
                "isPickerOnly": true,
                "pickerCallback": function(resources){callBack(resources);},
                "appPath": "{{ app.request.getBaseUrl }}",
                "webPath": "{{ asset('') }}",
                "resourceTypes": {
                    {% for resourceType in resourceTypes %}
                        "{{ resourceType.getName() }}": {
                            "name": "{{ resourceType.getName()|trans({}, 'resource') }}",
                            "customActions": {
                                {% for customAction in resourceType.getCustomActions() %}
                                    "{{ customAction.getAction() }}": {
                                        "name": "{{ customAction.getAction() }}",
                                        "route": "{{ path('claro_resource_custom', {'resourceType': resourceType.getName(), 'action': customAction.getAction(), 'instanceId': '_instanceId' }) }}",
                                        "async": {{ customAction.isAsync() }}
                                    }
                                    {% if loop.last != true %},{% endif %}
                                {% endfor %}
                            }
                        }
                        {% if loop.last != true %},{% endif %}
                    {% endfor %}
                }
            });

        $('#add_resource_button').click(function(){Claroline.ResourceManager.picker('open')});

        var callBack = function(resources){
            console.debug(resources);
            Claroline.Utilities.ajax({
            url: Routing.generate('claro_activity_add_resource', {'activityId':{{ activity.getId() }}, 'resourceId': _.keys(resources)[0]}),
            type: 'GET',
            success: function(resources){
                var html = "";
                html+= "<li>";
                html+= "<a href="+Routing.generate('claro_resource_open', {'resourceType': resources[0].type, 'action': 'open', 'resourceId': resources[0].id})+">"+resources[0].path_for_display+"</a> ";
                html+= " | <a class='remove-resource' href="+Routing.generate('claro_activity_remove_resource', {'resourceId':resources[0].id, 'activityId': {{ activity.getId() }} })+">{{ 'delete'|trans({}, 'platform') }}</a>";
                html+= "</li>";

                $("#resource-list").append(html);
            },
        });
        }

        $('.remove-resource').live('click', function(e){
            e.preventDefault();
            console.debug(e);
            Claroline.Utilities.ajax({
                url: e.target.href,
                type: 'DELETE',
                success: function(){
                    $(e.currentTarget.parentElement).remove();
                }
            });
        });
    });
    </script>
{% endblock %}
{% block section_content %}
    <h3>
        <b>{{ 'activity'|trans({}, 'resource') }} {{ activity.getName() }}</b>
    </h3>
    <div id="activity-instruction">
        <h4>{{ 'Instructions'|trans({}, 'platform') }} :</h4>
        {{ activity.getInstruction() }}
    </div>
    <br>
    <div id="resource_linked">
        {{ 'resources'|trans({}, 'platform') }}:
            <ul id="resource-list">
                {% for resource in activity.getResources() %}
                <li>
                     <a href="{{ path('claro_resource_open', {'resourceType': resource.getResourceType().getName(), 'action': 'open', 'resourceId': resource.getId()})}}"> {{ resource.getPathForDisplay() }}</a>
                     | <a class="remove-resource" href="{{ path('claro_activity_remove_resource', {'resourceId':resource.getId(), 'activityId': activity.getId()})}}">{{ 'delete'|trans({}, 'platform') }}</a>
                </li>
                {% endfor %}
            </ul>
    </div>

    <button id="add_resource_button" class="btn btn-secondary">{{'add_resource'|trans({},'platform')}}</button>
{% endblock %}